name: Publish Package

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'npm tag (latest or next)'
        required: true
        type: choice
        options:
          - latest
          - next
  repository_dispatch:
    types: [publish-package]

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@d6e32c1796099e0f1f3ac741c220a8b7eae9e5dd
        with:
          install: true
          cache: true
          experimental: true
        env:
          # Required for aqua-backed tool installs to avoid GitHub API rate limits in CI.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup
        run: mise run setup

      - name: Test
        run: mise run test

      - id: inputs
        uses: simenandre/setup-inputs@v1

      - name: Publish to npm with OIDC
        run: |
          TAG="${{ steps.inputs.outputs.tag }}"
          if [ -z "$TAG" ]; then
            TAG="latest"
          fi

          echo "Publishing with tag: $TAG"
          mise run publish --tag "$TAG"

      - name: Verify published version
        run: |
          set -euo pipefail

          TAG="${{ steps.inputs.outputs.tag }}"
          if [ -z "$TAG" ]; then
            TAG="latest"
          fi

          NAME="$(node -p 'require("./package.json").name')"
          VERSION="$(node -p 'require("./package.json").version')"
          echo "Checking npm dist-tag '$TAG' for ${NAME}@${VERSION}..."

          # npm registry can be eventually consistent right after publish.
          # Give it a short window to make the new version visible.
          for i in $(seq 1 20); do
            if npm view "${NAME}@${VERSION}" version >/dev/null 2>&1; then
              break
            fi

            if [ "$i" -eq 20 ]; then
              echo "[ERROR] npm does not report ${NAME}@${VERSION} after publish"
              exit 1
            fi

            echo "Waiting for npm to show ${NAME}@${VERSION} (${i}/20)..."
            sleep 3
          done

          for i in $(seq 1 20); do
            DIST_VERSION="$(npm view "${NAME}" dist-tags."${TAG}" 2>/dev/null || true)"
            if [ -n "$DIST_VERSION" ] && [ "$DIST_VERSION" = "$VERSION" ]; then
              break
            fi

            if [ "$i" -eq 20 ]; then
              echo "[ERROR] dist-tag '$TAG' points to ${DIST_VERSION:-<empty>} (expected $VERSION)"
              exit 1
            fi

            echo "Waiting for dist-tag '$TAG' to update (${i}/20)..."
            sleep 3
          done

            # Extra sanity checks: confirm the publish has provenance attached and looks like an OIDC publish.
            # These are best-effort signals (npm UI can lag), but they help catch accidental token-based publishes.
            EXPECTED_OIDC_EMAIL="npm-oidc-no-reply@github.com"
            NPM_USER_EMAIL=""
            NPM_USER_NAME=""
            for i in $(seq 1 20); do
              VIEW_JSON="$(npm view "${NAME}@${VERSION}" --json 2>/dev/null || true)"

              NPM_USER_EMAIL="$(
                printf '%s' "$VIEW_JSON" | node -e '
                  const fs = require("fs");
                  const s = fs.readFileSync(0, "utf8").trim();
                  if (!s) process.exit(0);
                  try {
                    const j = JSON.parse(s);
                    const u = j._npmUser ?? j.dist?._npmUser ?? null;
                    if (u && typeof u === "object" && u.email) process.stdout.write(String(u.email));
                  } catch {}
                '
              )"
              NPM_USER_NAME="$(
                printf '%s' "$VIEW_JSON" | node -e '
                  const fs = require("fs");
                  const s = fs.readFileSync(0, "utf8").trim();
                  if (!s) process.exit(0);
                  try {
                    const j = JSON.parse(s);
                    const u = j._npmUser ?? j.dist?._npmUser ?? null;
                    if (u && typeof u === "object" && u.name) process.stdout.write(String(u.name));
                  } catch {}
                '
              )"

              if [ "$NPM_USER_EMAIL" = "$EXPECTED_OIDC_EMAIL" ] || [ "$NPM_USER_NAME" = "$EXPECTED_OIDC_EMAIL" ]; then
                break
              fi

              if [ "$i" -eq 20 ]; then
                echo "[ERROR] expected OIDC publish; npm reports _npmUser.email='${NPM_USER_EMAIL:-<empty>}' _npmUser.name='${NPM_USER_NAME:-<empty>}'"
                exit 1
              fi

              echo "Waiting for npm _npmUser to show OIDC publisher (${i}/20)..."
              sleep 3
            done

            PREDICATE_TYPE=""
            for i in $(seq 1 20); do
              VIEW_JSON="$(npm view "${NAME}@${VERSION}" --json 2>/dev/null || true)"
              PREDICATE_TYPE="$(
                printf '%s' "$VIEW_JSON" | node -e '
                  const fs = require("fs");
                  const s = fs.readFileSync(0, "utf8").trim();
                  if (!s) process.exit(0);
                  try {
                    const j = JSON.parse(s);
                    const p = j.dist?.attestations?.provenance?.predicateType ?? "";
                    if (p) process.stdout.write(String(p));
                  } catch {}
                '
              )"

              if [ "$PREDICATE_TYPE" = "https://slsa.dev/provenance/v1" ]; then
                break
              fi

              if [ "$i" -eq 20 ]; then
                echo "[ERROR] missing/incorrect provenance attestation predicateType: '${PREDICATE_TYPE:-<empty>}'"
                exit 1
              fi

              echo "Waiting for provenance attestation predicateType (${i}/20)..."
              sleep 3
            done

            echo "âœ“ npm publish verification passed"

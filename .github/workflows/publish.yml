name: Publish Package

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'npm tag (latest or next)'
        required: true
        type: choice
        options:
          - latest
          - next
  repository_dispatch:
    types: [publish-package]

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@d6e32c1796099e0f1f3ac741c220a8b7eae9e5dd
        with:
          install: true
          cache: true
          experimental: true

      - name: Setup
        run: mise run setup

      - name: Test
        run: mise run test

      - id: inputs
        uses: simenandre/setup-inputs@v1

      - name: Publish to npm with OIDC
        run: |
          TAG="${{ steps.inputs.outputs.tag }}"
          if [ -z "$TAG" ]; then
            TAG="latest"
          fi

          echo "Publishing with tag: $TAG"
          mise run publish --tag "$TAG"

      - name: Verify published version
        run: |
          set -euo pipefail

          TAG="${{ steps.inputs.outputs.tag }}"
          if [ -z "$TAG" ]; then
            TAG="latest"
          fi

          NAME="$(node -p 'require("./package.json").name')"
          VERSION="$(node -p 'require("./package.json").version')"
          echo "Checking npm dist-tag '$TAG' for ${NAME}@${VERSION}..."

          # npm registry can be eventually consistent right after publish.
          # Give it a short window to make the new version visible.
          for i in $(seq 1 20); do
            if npm view "${NAME}@${VERSION}" version >/dev/null 2>&1; then
              break
            fi

            if [ "$i" -eq 20 ]; then
              echo "[ERROR] npm does not report ${NAME}@${VERSION} after publish"
              exit 1
            fi

            echo "Waiting for npm to show ${NAME}@${VERSION} (${i}/20)..."
            sleep 3
          done

          for i in $(seq 1 20); do
            DIST_VERSION="$(npm view "${NAME}" dist-tags."${TAG}" 2>/dev/null || true)"
            if [ -n "$DIST_VERSION" ] && [ "$DIST_VERSION" = "$VERSION" ]; then
              break
            fi

            if [ "$i" -eq 20 ]; then
              echo "[ERROR] dist-tag '$TAG' points to ${DIST_VERSION:-<empty>} (expected $VERSION)"
              exit 1
            fi

            echo "Waiting for dist-tag '$TAG' to update (${i}/20)..."
            sleep 3
          done

          echo "âœ“ npm publish verification passed"
